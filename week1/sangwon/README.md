# chapter4 처리율 제한 장치의 설계

## 케이스 1: 커뮤니티 서비스

- SNS 커뮤니티 서비스이다
- 사용자는 글 작성 후 5분 내에 다른 글을 작성할 수 없다
- 동일한 IP에서 10분 내에 다른 글을 작성할 수 없다
- 분산 환경에서 처리되어야 한다
- 서비스의 gateway는 상용 서비스를 사용 중이다

## 설계 방향

- 사용자가 글을 작성하러 진입하는 시점에 레디스에 작성한 이력이 있는지 확인
- 이력이 없다면 글 작성 페이지 진입
- 글 작성을 완료하면 레디스에 작성자 회원 번호 저장
  - TTL 은 5분
- 글 작성 후 5분 내에 글 작성 시도를 하면 레디스를 조회해서 만료되지 않은 회원번호가 있는지 확인

### 글 작성 프로세스

![](/week1/sangwon/images/pic1.png)

### 글 작성 불가 프로세스

![](/week1/sangwon/images/pic2.png)

## 케이스 2: 온라인 커머스 (티케팅, 선착순 구매)

- 오전 11시 야구 굿즈를 판매한다
- 해당 상품에 대기열 페이지를 적용할 예정이다
- 대기열 서비스는 상용 서비스를 사용할 수 있지만 직접 구현해서 사용한다
- 토큰 버킷 알고리즘을 사용해서 트래픽을 제어한다

![](/week1/sangwon/images/pic3.png)

### 프로세스

1.  사용자 -> (요청) -> 서버
2.  서버 -> (요청 키 전송) -> 카프카 & 레디스
3.  사용자 -> (대기 페이지에서 접속) -> 웹소켓 서버
4.  웹소켓 서버 -> (순번 조회) -> 레디스
5.  컨슈머 -> (키 가져오기) -> 카프카
6.  컨슈머 -> (토큰 버킷 알고리즘)
7.  컨슈머 -> (처리 후 상태 변경) -> 레디스
8.  웹소켓 서버 -> ("입장 가능" 푸시) -> 사용자
9.  사용자 -> (페이지 이동) -> 실제 서비스
